å‰é¢åˆ†æäº†åœ¨ Nacos åœ¨å®¢æˆ·ç«¯æ˜¯å¦‚ä½•å®ç°åŠ¨æ€æ›´æ–°é…ç½®çš„ï¼Œæœ¬æ–‡å°±æ¥åˆ†æä¸€ä¸‹åœ¨ Nacos console ä¿®æ”¹äº†é…ç½®ä»¥åï¼ŒæœåŠ¡ç«¯åº•å±‚åšäº†å“ªäº›å¤„ç†ã€‚æ¯”å¦‚ï¼š

- æŒä¹…åŒ–åˆ° Mysql
- å†™å…¥ç£ç›˜
- é€šçŸ¥å®¢æˆ·ç«¯

## æœåŠ¡ç«¯æ¥æ”¶è¯·æ±‚

åœ¨æ§åˆ¶å°é¡µé¢æ›´æ–°ä¸€é¡¹é…ç½®ï¼Œçœ‹çœ‹æ§åˆ¶å°å‘é€äº†ä»€ä¹ˆè¯·æ±‚ç»™æœåŠ¡ç«¯ã€‚

![image-20241120140118352](./Nacosæºç åˆ†æ-æ›´æ–°é…ç½®æ—¶æœåŠ¡ç«¯åšäº†ä»€ä¹ˆ.assets/image-20241120140118352.png)

![image-20241120140048490](./Nacosæºç åˆ†æ-æ›´æ–°é…ç½®æ—¶æœåŠ¡ç«¯åšäº†ä»€ä¹ˆ.assets/image-20241120140048490.png)

æ§åˆ¶å°å‘é€äº†ä¸€ä¸ª POST è¯·æ±‚ï¼š`/nacos/v1/cs/configs`ï¼Œåœ¨[å®˜æ–¹ APIæŒ‡å—](https://nacos.io/docs/v1/open-api/) å¯ä»¥æ‰¾åˆ° API å®šä¹‰ã€‚

![image-20241120140623329](./Nacosæºç åˆ†æ-æ›´æ–°é…ç½®æ—¶æœåŠ¡ç«¯åšäº†ä»€ä¹ˆ.assets/image-20241120140623329.png)

> æˆ‘ Nacos æºç æ˜¯ 2.* ç‰ˆæœ¬ï¼Œä½†æ˜¯æ‰“å¼€çš„ console å‘å¸ƒé…ç½®è¯·æ±‚çš„ API è¿˜æ˜¯ 1.* ç‰ˆæœ¬ã€‚ä¸è¿‡å®˜æ–¹è¯´ï¼Œv2 æ˜¯å…¼å®¹ v1 çš„ï¼Œåœ¨ Controller å±‚é¢ä¸¤ä¸ªç‰ˆæœ¬ä½¿ç”¨çš„ä¹Ÿæ˜¯ç›¸åŒçš„ Service ç±»å¤„ç†è¯·æ±‚ã€‚

è¯·æ±‚è¿›å…¥**com.alibaba.nacos.config.server.controller.ConfigController#publishConfig**ï¼Œå°è£…é…ç½®å’Œè¯·æ±‚ä¿¡æ¯è°ƒç”¨`com.alibaba.nacos.config.server.service.ConfigOperationService#publishConfig`ã€‚

![image-20241120142833789](./Nacosæºç åˆ†æ-æ›´æ–°é…ç½®æ—¶æœåŠ¡ç«¯åšäº†ä»€ä¹ˆ.assets/image-20241120142833789.png)

`publishConfig`æ–¹æ³•åšäº†ä¸¤ä»¶äº‹ï¼š

- æ·»åŠ æˆ–æ›´æ–°é…ç½®ä¿¡æ¯åˆ°æ•°æ®åº“
- å‘å¸ƒé…ç½®æ•°æ®å˜æ›´äº‹ä»¶`ConfigDataChangeEvent`ï¼Œè¿™æ˜¯å®¢æˆ·ç«¯èƒ½æ„ŸçŸ¥é…ç½®æ›´æ–°çš„æ ¹æœ¬åŸå› 

![image-20241121165044280](./Nacosæºç åˆ†æ-æ›´æ–°é…ç½®æ—¶æœåŠ¡ç«¯åšäº†ä»€ä¹ˆ.assets/image-20241121165044280.png)

`ConfigDataChangeEvent`è¢«ä¸¤ä¸ªç±»ç›‘å¬ï¼š

- `DumpService`: å°†é…ç½®ä¿¡æ¯è½¬å­˜åˆ°æœ¬åœ°ç£ç›˜
- `AsyncNotifyService`ï¼šé€šçŸ¥é›†ç¾¤å…¶ä»–èŠ‚ç‚¹å’Œè®¢é˜…é…ç½®çš„å®¢æˆ·ç«¯é…ç½®å‘ç”Ÿå˜æ›´

## è½¬å­˜é…ç½®ä¿¡æ¯åˆ°æœ¬åœ°ç£ç›˜

`DumpService`åœ¨æ„é€ å‡½æ•°ä¸­è®¢é˜…äº†`ConfigDataChangeEvent`äº‹ä»¶ï¼Œå½“ç›‘å¬åˆ°äº‹ä»¶å‘ç”Ÿï¼Œè°ƒç”¨`handleConfigDataChange`æ–¹æ³•ã€‚

![image-20241121170312201](./Nacosæºç åˆ†æ-æ›´æ–°é…ç½®æ—¶æœåŠ¡ç«¯åšäº†ä»€ä¹ˆ.assets/image-20241121170312201.png)

> æˆ‘å›çœ‹äº†ä¸€ä¸‹å‰é¢çš„æ–‡ç« ï¼Œä¸€äº›ä¸é‡è¦çš„æ–¹æ³•ä¹Ÿæœ‰æˆªå›¾ï¼Œç™½ç™½çš„æµªè´¹äº†å¤§å®¶çš„é˜…è¯»æ—¶é—´ï¼Œå¯¹äºç®€å•çš„æ–¹æ³•åé¢åªä¼šåˆ—å‡ºæ–¹æ³•è°ƒç”¨é“¾è·¯

- ğŸ‘‡`handleConfigDataChange(Event event)` 
- ğŸ‘‡`dumpFormal(String dataId, String group, String tenant, long lastModified, String handleIp)`

`dumpFormal`æ–¹æ³•ä½œç”¨æ˜¯è½¬å­˜æ­£å¼æ•°æ®åˆ°ç£ç›˜ï¼Œå‘ä»»åŠ¡ç®¡ç†å™¨`dumpTaskMgr`æäº¤äº†ä¸€ä¸ª ä»»åŠ¡`DumpTask`ã€‚

![image-20241121171502273](./Nacosæºç åˆ†æ-æ›´æ–°é…ç½®æ—¶æœåŠ¡ç«¯åšäº†ä»€ä¹ˆ.assets/image-20241121171502273.png)

`dumpTaskMgr`æ˜¯`TaskManager`å®ä¾‹ï¼Œ`DumpService`çš„æ„é€ å‡½æ•°ä¸­åˆ›å»ºäº†å®ä¾‹ï¼Œå¹¶ä¸”ä¸ºå®ƒæŒ‡å®šäº†`DumpProcessor`ä½œä¸ºé»˜è®¤ä»»åŠ¡å¤„ç†å™¨

![image-20241122095303734](./Nacosæºç åˆ†æ-æ›´æ–°é…ç½®æ—¶æœåŠ¡ç«¯åšäº†ä»€ä¹ˆ.assets/image-20241122095303734.png)

`TaskManager`ç±»æœ¬èº«æ²¡æœ‰å®ç°æ‰§è¡Œä»»åŠ¡çš„æ–¹æ³•ï¼Œè€Œæ˜¯ç»§æ‰¿è‡ª` NacosDelayTaskExecuteEngine`, æ¥çœ‹ä¸‹ä»–æ˜¯å¦‚ä½•æ‰§è¡Œä»»åŠ¡çš„ã€‚

åœ¨æ„é€ å‡½æ•°ä¸­åˆ›å»ºå•çº¿ç¨‹æ‰§è¡Œå™¨ï¼Œç¡®ä¿ä»»åŠ¡éƒ½èƒ½å¤„ç†æˆåŠŸï¼Œå¹¶ä¸”æ¯ä¸ªä»»åŠ¡ä¹‹é—´é—´éš” 100 æ¯«ç§’ã€‚

![image-20241121173736126](./Nacosæºç åˆ†æ-æ›´æ–°é…ç½®æ—¶æœåŠ¡ç«¯åšäº†ä»€ä¹ˆ.assets/image-20241121173736126.png)

`ProcessRunnable`å®ç°äº†`Runnable`æ¥å£ï¼Œåœ¨`run`æ–¹æ³•å†…è°ƒç”¨`processTaks`æ–¹æ³•å¤„ç†ä»»åŠ¡

![image-20241121174039790](./Nacosæºç åˆ†æ-æ›´æ–°é…ç½®æ—¶æœåŠ¡ç«¯åšäº†ä»€ä¹ˆ.assets/image-20241121174039790.png)

é€šè¿‡ taskKey è·å–`NacosTaskProcessor`ç±»å‹çš„å¤„ç†å™¨ï¼Œè°ƒç”¨å¤„ç†å™¨çš„`process`æ–¹æ³•ï¼Œå¹¶ä¸”ä¸ºä»»åŠ¡å¢åŠ äº†é‡è¯•æœºåˆ¶ã€‚

`NacosTaskProcessor`æ˜¯ä¸€ä¸ªå¤„ç†å™¨æ¥å£ï¼Œä»–æœ‰å¾ˆå¤šå®ç°ï¼Œåˆ†åˆ«ç”¨æ¥å¤„ç†ä¸åŒçš„ä»»åŠ¡

![image-20241121175209799](./Nacosæºç åˆ†æ-æ›´æ–°é…ç½®æ—¶æœåŠ¡ç«¯åšäº†ä»€ä¹ˆ.assets/image-20241121175209799.png)

dump æ­£å¼æ•°æ®æ˜¯ç”±ä¸Šé¢æŒ‡å®šçš„é»˜è®¤ä»»åŠ¡å¤„ç†å™¨`DumpProcessor`æ¥å¤„ç†ä»»åŠ¡ï¼Œæ‰§è¡Œå¤„ç†å™¨çš„çš„`process`æ–¹æ³•

- ğŸ‘‡process(NacosTask task)
- ğŸ‘‡DumpConfigHandler.configDump(build.build())
- ğŸ‘‡ConfigCacheService.dump(dataId, group, namespaceId, content, lastModified, event.getType(),  event.getEncryptedDataKey())
- ğŸ‘‡dumpWithMd5(dataId, group, tenant, content, null, lastModifiedTs, type, encryptedDataKey)
- ğŸ‘‡ConfigDiskServiceFactory.getInstance().saveToDisk(dataId, group, tenant, content)

è°ƒç”¨`saveToDisk`æ–¹æ³•ä¿å­˜åˆ°ç£ç›˜ï¼›`updateMd5`æ–¹æ³•æ›´æ–°æœ¬åœ°ç¼“å­˜çš„ md5å’Œæœ€åæ›´æ–°æ—¶é—´ï¼Œå¹¶å‘å¸ƒ`LocalDataChangeEvent`äº‹ä»¶ã€‚

![image-20241122173301754](./Nacosæºç åˆ†æ-æ›´æ–°é…ç½®æ—¶æœåŠ¡ç«¯åšäº†ä»€ä¹ˆ.assets/image-20241122173301754.png)

è¿›å…¥`com.alibaba.nacos.config.server.service.dump.disk.ConfigRawDiskService#saveToDisk`, å¯ä»¥çœ‹åˆ°`targetFile`å°±æ˜¯`nacos.home`ä¸‹è¦æ›´æ–°çš„æ–‡ä»¶è·¯å¾„ï¼Œå‘æ–‡ä»¶å†™å…¥æ–°çš„é…ç½®ä¿¡æ¯ã€‚![image-20241122173750569](./Nacosæºç åˆ†æ-æ›´æ–°é…ç½®æ—¶æœåŠ¡ç«¯åšäº†ä»€ä¹ˆ.assets/image-20241122173750569.png)

ç»§ç»­çœ‹`updateMd5`æ–¹æ³•ï¼Œå‘å¸ƒæœ¬åœ°æ•°æ®å˜æ›´äº‹ä»¶ï¼Œè¿™ä¸ªäº‹ä»¶çš„ç›®çš„å°±æ˜¯å‘Šè¯‰å®¢æˆ·ç«¯ï¼šé…ç½®å‘ç”Ÿäº†å˜æ›´

![image-20241122174633242](./Nacosæºç åˆ†æ-æ›´æ–°é…ç½®æ—¶æœåŠ¡ç«¯åšäº†ä»€ä¹ˆ.assets/image-20241122174633242.png)

## é€šçŸ¥å®¢æˆ·ç«¯é…ç½®å˜æ›´

ä¸€å…±æœ‰ä¸¤å¤„ç›‘å¬äº†æœ¬åœ°æ•°æ®å˜æ›´äº‹ä»¶ï¼Œå…ˆçœ‹ç¬¬ä¸€ä¸ªï¼š`RpcConfigChangeNotifier`

### RpcConfigChangeNotifier



![image-20241122175117634](./Nacosæºç åˆ†æ-æ›´æ–°é…ç½®æ—¶æœåŠ¡ç«¯åšäº†ä»€ä¹ˆ.assets/image-20241122175117634.png)