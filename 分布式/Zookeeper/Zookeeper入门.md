# Zookeeper入门

## 概述

ZooKeeper 是 Apache 软件基金会的一个软件项目，它为大型分布式计算提供开源的**分布式配置服务、同步服务和命名注册**；ZooKeeper 的架构通过冗余服务实现高可用性（CP）。

Zookeeper 的设计目标是将那些复杂且容易出错的分布式一致性服务封装起来，构成一个高效可靠的原语集，并以一系列简单易用的接口提供给用户使用

> Zookeeper 可以理解为一个分布式协调服务，本质：小型的文件存储系统 + 监听通知机制；如存储配置信息和监听配置的变更

## 数据结构

zookeeper本身是一个**树形目录服务**（名称空间），非常类似于**标准文件系统**，key-value 的形式存储。名称 key 由斜线 / 分割的一系列路径元素，zookeeper 名称空间中的每个节点都是由一个路径来标识的。

![image-20231126204148216](./Zookeeper%E5%85%A5%E9%97%A8.assets/image-20231126204148216.png)

> 每个路径下的节点key(完整路径，名称)是唯一的，即同一级节点 key 名称是唯一的
>
> 每个节点中存储了节点value和对应的状态属性（多个）

## 节点类型

- PERSISTENT：持久节点，创建成功以后不会自动删除 (默认）
- PERSISTENT_SEQUENTIAL：持久顺序节点，创建时zookeeper 会在路径上加上序号作为后缀，**非常适合用于分布式锁、分布式选举等场景**，创建时添加 -s 参数
- EPHEMERAL：**临时节点(不可在拥有子节点)**，跟连接会话绑定，临时节点会在客户端会话断开后由zk服务端自动删除。**适用于心跳，服务发现等场景**，创建时添加 -e 参数
- EPHEMERAL_SEQUENTIAL：临时顺序节点(不可在拥有子节点)，与持久顺序节点类似，不同之处在于EPHEMERAL_SEQUENTIAL是临时的，会在会话断开后删除，创建时添加 -e -s 参数
- CONTAINER：容器节点，当子节点都被删除后，Container 也随即删除，创建时添加 -c 参数
- PERSISTENT_WITH_TTL：TTL节点，客户端断开连接后不会自动删除Znode，如果该Znode没有子Znode且在给定TTL时间内无修改，该Znode将会被删除；单位是毫秒；创建时添加 -t 参数

## 常见的客户端操作命令

| 命令             | 描述                   | 用法示例                                                    | 说明                                                         |
| ---------------- | ---------------------- | ----------------------------------------------------------- | ------------------------------------------------------------ |
| ls               | 查看某个路径下目录列表 | ls [-s] [-w] [-R] path                                      | path：代表路径，完整路径<br/>-s：返回状态信息<br/>-w：监听节点变化<br/>-R:递归查看某路径下目录列表 |
| create           | 创建节点并赋值         | create [-s] [-e] [-c] [-t ttl] path [data] [acl]            | [-s] [-e]：-s 和 -e 都是可选的，-s 代表顺序节点， -e 代表临时节点，注意其中 -s 和 -e 可以同时使用的，并且临时节点不能再创建子节点<br/>path：指定要创建节点的路径，比如 /runoob<br/>data：要在此节点存储的数据<br/>acl：访问权限相关，默认是 world，相当于全世界都能访问 |
| set              | 修改节点存储的数据     | set [-s] [-v version] path data                             | path：节点路径。<br/>data：需要存储的数据。<br/>[version]：可选项，版本号(可用作乐观锁) |
| get              | 获取节点数据和状态信息 | get [-s] [-w] path                                          | -s：返回结果带上状态信息<br/>-w:返回数据并对对节点进行事件监听(触发事件后停止监听) |
| stat             | 获取节点数据和状态信息 | stat [-w] path                                              | path：代表路径<br/>-w:对节点进行事件监听                     |
| delete/deleteall | 删除某节点             | delete [-v version] path<br/>deleteall path [-b batch size] | 如果某节点不为空，则不能用delete命令删除                     |

## 数据模型 znode 结构

![image-20231126212029617](./Zookeeper%E5%85%A5%E9%97%A8.assets/image-20231126212029617.png)

| 状态属性       | 描述                                                         |
| -------------- | ------------------------------------------------------------ |
| cZxid          | 创建节点时的事务ID                                           |
| ctime          | 创建节点时的时间                                             |
| mZxid          | 最后修改节点时的事务ID                                       |
| mtime          | 最后修改节点时的时间                                         |
| pZxid          | 表示该节点的子节点列表最后一次修改的事务ID，添加子节点或删除子节点就会影响子节点列表，但是修改子节点的数据内容则不影响该ID（注意，只有子节点列表变更了才会变更pzxid，子节点内容变更不会影响pzxid） |
| cversion       | 子节点版本号，子节点每次修改版本号加1                        |
| dataversion    | 数据版本号，数据每次修改该版本号加1                          |
| aclversion     | 权限版本号，权限每次修改该版本号加1                          |
| ephemeralOwner | 创建该临时节点的会话的sessionID。（**如果该节点是持久节点，那么这个属性值为0）** |
| dataLength     | 该节点的数据长度                                             |
| numChildren    | 该节点拥有子节点的数量（只统计直接子节点的数量）             |

